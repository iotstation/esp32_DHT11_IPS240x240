#include <Adafruit_GFX.h>   //Core graphics library for drawing shapes, text, etc.
#include <Adafruit_ST7789.h> //Specific driver for the ST7789 TFT display
#include <SPI.h>
#include <DHT.h>

// TFT pins
#define TFT_CS     5
#define TFT_RST    15   // Updated pin
#define TFT_DC     2
#define TFT_SCLK   18
#define TFT_MOSI   23

// DHT11 pin
#define DHTPIN     4
#define DHTTYPE    DHT11

Adafruit_ST7789 tft = Adafruit_ST7789(TFT_CS, TFT_DC, TFT_RST);
DHT dht(DHTPIN, DHTTYPE);

// ===== Bitmaps =====
// Humidity icon
const unsigned char epd_bitmap_humidity__1_ [] PROGMEM = {
 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x3f, 0xfe, 0x7f, 0xff, 
	0xff, 0xff, 0xff, 0xf8, 0x1f, 0xfc, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1f, 0xfc, 0x3f, 0xff, 
	0xff, 0xff, 0xff, 0xf0, 0x0f, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xf8, 0x1f, 0xff, 
	0xff, 0xff, 0xff, 0xe1, 0x87, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xe1, 0x87, 0xf0, 0x0f, 0xff, 
	0xff, 0xff, 0xff, 0xc3, 0xc3, 0xf0, 0x0f, 0xff, 0xff, 0xff, 0xff, 0x83, 0xc1, 0xf0, 0x0f, 0xff, 
	0xff, 0xff, 0xff, 0x87, 0xe1, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0x07, 0xe0, 0xfc, 0x3f, 0xff, 
	0xff, 0xff, 0xff, 0x0f, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x3f, 0xfc, 0x3f, 0xff, 0xff, 
	0xff, 0xff, 0xfc, 0x3f, 0xfc, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0xfe, 0x1f, 0xff, 0xff, 
	0xff, 0xff, 0xf0, 0x7f, 0xfe, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0x0f, 0xff, 0xff, 
	0xff, 0xff, 0xf0, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0x87, 0xff, 0xff, 
	0xff, 0xff, 0xe1, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xc3, 0xff, 0xff, 
	0xff, 0xff, 0xc3, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 0xc1, 0xff, 0xff, 
	0xff, 0xff, 0x87, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xe1, 0xff, 0xff, 
	0xff, 0xff, 0x0f, 0x87, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x81, 0xff, 0xf0, 0xff, 0xff, 
	0xff, 0xff, 0x0f, 0x00, 0xfc, 0xf0, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0x00, 0x00, 0xf8, 0x7f, 0xff, 
	0xff, 0xfe, 0x1f, 0x00, 0x00, 0xf8, 0x7f, 0xff, 0xff, 0xfe, 0x1e, 0x00, 0x00, 0x78, 0x7f, 0xff, 
	0xff, 0xfc, 0x3e, 0x00, 0x00, 0x7c, 0x3f, 0xff, 0xff, 0xfc, 0x3c, 0x00, 0x00, 0x7c, 0x3f, 0xff, 
	0xff, 0xfc, 0x3c, 0x00, 0x00, 0x3c, 0x3f, 0xff, 0xff, 0xfc, 0x3c, 0x00, 0x00, 0x3c, 0x3f, 0xff, 
	0xff, 0xfc, 0x3c, 0x00, 0x00, 0x3c, 0x3f, 0xff, 0xff, 0xfc, 0x3c, 0x00, 0x00, 0x3c, 0x3f, 0xff, 
	0xff, 0xfc, 0x3e, 0x00, 0x00, 0x7c, 0x3f, 0xff, 0xff, 0xfc, 0x3e, 0x00, 0x00, 0x7c, 0x3f, 0xff, 
	0xff, 0xfe, 0x1e, 0x00, 0x00, 0x78, 0x7f, 0xff, 0xff, 0xfe, 0x1f, 0x00, 0x00, 0xf8, 0x7f, 0xff, 
	0xff, 0xfe, 0x0f, 0x80, 0x01, 0xf0, 0x7f, 0xff, 0xff, 0xff, 0x0f, 0xc0, 0x03, 0xf0, 0xff, 0xff, 
	0xff, 0xff, 0x07, 0xe0, 0x07, 0xe0, 0xff, 0xff, 0xff, 0xff, 0x83, 0xfc, 0x3f, 0xc1, 0xff, 0xff, 
	0xff, 0xff, 0x81, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0x03, 0xff, 0xff, 
	0xff, 0xff, 0xe0, 0x7f, 0xfe, 0x07, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xf0, 0x0f, 0xff, 0xff, 
	0xff, 0xff, 0xfc, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0x80, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

// Temperature icon
const unsigned char epd_bitmap_temperature__1_ [] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xe0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0x83, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xe0, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0x0f, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x00, 0x38, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x38, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xf8, 0x3f, 0xff, 0xff, 
	0xff, 0xff, 0xf8, 0x3f, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x7f, 0xfe, 0x0f, 0xff, 0xff, 
	0xff, 0xff, 0xf0, 0xff, 0xff, 0x07, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0x83, 0xff, 0xff, 
	0xff, 0xff, 0xe3, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xc3, 0xff, 0xff, 
	0xff, 0xff, 0xc7, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xe1, 0xff, 0xff, 
	0xff, 0xff, 0x87, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xe1, 0xff, 0xff, 
	0xff, 0xff, 0x87, 0xff, 0xff, 0x21, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0x21, 0xff, 0xff, 
	0xff, 0xff, 0x87, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0x21, 0xff, 0xff, 
	0xff, 0xff, 0xc7, 0xff, 0xfe, 0x63, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xfc, 0x43, 0xff, 0xff, 
	0xff, 0xff, 0xc1, 0xff, 0xf8, 0x83, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xf1, 0x87, 0xff, 0xff, 
	0xff, 0xff, 0xe0, 0xff, 0x03, 0x07, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x7e, 0x0e, 0x0f, 0xff, 0xff, 
	0xff, 0xff, 0xf8, 0x1f, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x01, 0x80, 0x3f, 0xff, 0xff, 
	0xff, 0xff, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x01, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xe0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

void setup() {
  Serial.begin(115200);
  dht.begin();

  tft.init(240, 240, SPI_MODE2); //Initializes the TFT display with a resolution of 240×240 pixels. SPI_MODE2 sets the SPI communication mode (clock polarity and phase).
  tft.setRotation(2); // - Rotates the display orientation. 2 typically means 180° rotation.
  tft.fillScreen(ST77XX_BLACK);// Clears the screen and fills it with black

  tft.setTextSize(2); // Sets the font size
  tft.setTextColor(ST77XX_WHITE);
  tft.setCursor(20, 20);
  tft.println("Temp & Humidity");
}

void loop() {
  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  if (isnan(temperature) || isnan(humidity)) {
    Serial.println("Failed to read from DHT sensor!");
    delay(2000);
    return;
  }

  Serial.print("Temperature: "); Serial.print(temperature); Serial.print(" C, ");
  Serial.print("Humidity: "); Serial.print(humidity); Serial.println(" %");

  // Clear previous values (keep black background)
  tft.fillScreen(ST77XX_BLACK);

  // Redraw title
  tft.setTextSize(2);
  tft.setTextColor(ST77XX_WHITE);
  tft.setCursor(20, 20);
  tft.println("Temp & Humidity");

  // Draw temperature icon in yellow
  tft.drawBitmap(60, 60, epd_bitmap_temperature__1_, 64, 64, ST77XX_YELLOW); // - Draws a temperature icon at position (60, 60) with size 64×64 pixels in yellow.
  tft.setCursor(40, 140); // Moved below icon (60+64=124) + 16 for two rows
  tft.setTextColor(ST77XX_WHITE);
  tft.setTextSize(2);
  tft.print(temperature);
  tft.println(" C");

  // Draw humidity icon in blue
  tft.drawBitmap(140, 60, epd_bitmap_humidity__1_, 64, 64, ST77XX_CYAN);
  tft.setCursor(130, 140); // Moved below icon (60+64=124) + 16 for two rows
  tft.setTextColor(ST77XX_WHITE);
  tft.setTextSize(2);
  tft.print(humidity);
  tft.println(" %");

  delay(8000);
}